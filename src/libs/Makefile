SOURCE = $(shell ls *.c)
ASSEMBLY = $(SOURCE:.c=.s)
OBJECTS = $(ASSEMBLY:.s=.o) crt.o io.o

# Compiler
COMPILER = gcc
COMPILER_CODE32_OPTION = -m32
COMPILER_DONT_LINK_OPTION = -c
COMPILER_DONT_USE_STDLIB_OPTION = -nostdlib
COMPILER_FNO_BUILTIN_OPTION = -fno-builtin
COMPILER_FNO_PIE_OPTION = -fno-pie
COMPILER_OUTPUT_ASSEMBLY_OPTION = -S
COMPILER_OUTPUT_OPTION = -o
COMPILER_WARNING_OPTION = -Wall -Wextra

all: $(OBJECTS)

clean:
	rm -f $(ASSEMBLY) $(OBJECTS)

rebuild: clean
	make

$(OBJECTS): $(@:.o=.s)

$(ASSEMBLY): $(@:.s=.c)

%.o: %.s
	$(COMPILER) $^ $(COMPILER_CODE32_OPTION) $(COMPILER_DONT_LINK_OPTION) $(COMPILER_DONT_USE_STDLIB_OPTION) $(COMPILER_OUTPUT_OPTION) $@ $(COMPILER_WARNING_OPTION)

%.s: %.c
	$(COMPILER) $^ $(COMPILER_CODE32_OPTION) $(COMPILER_OUTPUT_ASSEMBLY_OPTION) $(COMPILER_FNO_BUILTIN_OPTION) $(COMPILER_FNO_PIE_OPTION) $(COMPILER_OUTPUT_OPTION) $@ $(COMPILER_WARNING_OPTION)

# Don't remove intermediate files
.PRECIOUS: %.o %.s

