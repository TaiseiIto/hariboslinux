APP_NAME = $(shell basename `pwd`)
TARGET = $(APP_NAME:=.elf)
SOURCE = $(shell ls *.c)
ASSEMBLY = $(SOURCE:.c=.s)
OBJECTS = $(ASSEMBLY:.s=.o) ../../libs/crt.o
MAP = $(APP_NAME:=.map)

# Compiler
COMPILER = gcc
COMPILER_CODE32_OPTION = -m32
COMPILER_DONT_LINK_OPTION = -c
COMPILER_OUTPUT_ASSEMBLY_OPTION = -S
COMPILER_OUTPUT_OPTION = -o
COMPILER_WARNING_OPTION = -Wall -Wextra

# Linker
LINKER = ld
LINKER_I386_OPTION = -m elf_i386
LINKER_MAP_OPTION = -Map $(MAP)
LINKER_OUTPUT_OPTION = -o

all: $(TARGET)

clean:
	rm -f $(ASSEMBLY) $(MAP) $(OBJECTS) $(TARGET)

rebuild: clean
	make

$(TARGET): $(OBJECTS)
	$(LINKER) $^ $(LINKER_I386_OPTION) $(LINKER_MAP_OPTION) $(LINKER_OUTPUT_OPTION) $@

$(OBJECTS): $(@:.o=.s)

$(ASSEMBLY): $(@:.s=.c)

%.o: %.s
	$(COMPILER) $^ $(COMPILER_CODE32_OPTION) $(COMPILER_DONT_LINK_OPTION) $(COMPILER_OUTPUT_OPTION) $@ $(COMPILER_WARNING_OPTION)

%.s: %.c
	$(COMPILER) $^ $(COMPILER_CODE32_OPTION) $(COMPILER_OUTPUT_ASSEMBLY_OPTION) $(COMPILER_OUTPUT_OPTION) $@ $(COMPILER_WARNING_OPTION)

# Don't remove intermediate files
.PRECIOUS: %.elf %.o %.s

